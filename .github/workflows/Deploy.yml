name: Deploy Payflow

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy (e.g., dev, prod)'
        required: true
        default: dev
      target:
        description: 'Target hosts to deploy (e.g., dfs1-dev)'
        required: true
        default: dfs1-dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Ansible
      run: |
        python -m venv .venv
        source .venv/bin/activate
        pip install ansible

    - name: Deploy Payflow
      run: |
        echo "payflow_dev" > vault_password.txt
        ansible-playbook -i inventory.ini plays/infrastructure.yml \
          -e "environment=${{ inputs.environment }}" \
          -l ${{ inputs.target }} -t payflow \
          --vault-password-file vault_pass.txt -CD -k
        rm -f vault_password.txt
